generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  user_id             Int                     @id @default(autoincrement())
  username            String                  @unique @db.VarChar(50)
  password            String                  @db.VarChar(255)
  email               String                  @unique @db.VarChar(100)
  role                String                  @default("Karyawan") @db.VarChar(20)
  status_karyawan     String                  @default("Magang") @db.VarChar(20)
  status              String                  @default("pending") @db.VarChar(20)
  created_at          DateTime                @default(now())
  employee            Employee?
  reset_tokens        password_reset_tokens[]
  approvedAttendances Attendance[]            @relation("AttendanceApprovals")
  approvedOvertimes Overtime[] @relation("OvertimeApprovals")
   subscription        Subscription?

  @@map("users")
}

model Employee {
  employee_id        Int            @id @default(autoincrement())
  user_id            Int?           @unique
  nama_lengkap       String         @db.VarChar(100)
  jenis_kelamin      String?        @db.VarChar(20)
  alamat             String?        @db.Text
  no_hp              String?        @db.VarChar(20)
  jabatan            String?        @db.VarChar(50)
  tanggal_masuk      DateTime?
  status_karyawan    String         @default("Tetap") @db.VarChar(20)
  gaji_pokok         Decimal        @default(5000000.00) @db.Decimal(15, 2)
  created_at         DateTime       @default(now())
  monthly_leave_quota          Int     @default(3)
  current_month                String? @db.VarChar(7)
  used_leave_days_this_month   Int     @default(0)
  attendance         Attendance[]
  user               User?          @relation(fields: [user_id], references: [user_id])
  leave_requests     LeaveRequest[]
  payroll            Payroll[]
  performance        Performance[]
  employee_schedules           EmployeeSchedule[]
  overtime         Overtime[]

  @@map("employees")
}

model SubscriptionPlan {
  plan_id       Int            @id @default(autoincrement())
  plan_name     String         @db.VarChar(50) // "Basic", "Pro", "Enterprise"
  price         Decimal        @db.Decimal(15, 2) // Harga per bulan
  duration_days Int            @default(30) // Durasi langganan (hari)
  features      String         @db.Text // JSON string fitur
  max_employees Int?           // Batas jumlah karyawan (null = unlimited)
  is_active     Boolean        @default(true)
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  subscriptions Subscription[]

  @@map("subscription_plans")
}

// ✅ TAMBAHAN BARU: Table Subscription (User's Active Subscription)
model Subscription {
  subscription_id Int      @id @default(autoincrement())
  user_id         Int      @unique
  plan_id         Int
  status          String   @default("inactive") @db.VarChar(20) // active, inactive, expired, pending
  start_date      DateTime?
  end_date        DateTime?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  // Relations
  user            User             @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  plan            SubscriptionPlan @relation(fields: [plan_id], references: [plan_id])
  payments        Payment[]

  @@index([user_id])
  @@index([plan_id])
  @@index([status])
  @@map("subscriptions")
}

// ✅ TAMBAHAN BARU: Table Payments (Payment History)
model Payment {
  payment_id      Int          @id @default(autoincrement())
  subscription_id Int
  order_id        String       @unique @db.VarChar(100) // Midtrans order_id
  amount          Decimal      @db.Decimal(15, 2)
  status          String       @default("pending") @db.VarChar(20) // pending, success, failed, expired
  payment_type    String?      @db.VarChar(50) // bank_transfer, credit_card, etc
  transaction_id  String?      @db.VarChar(100) // Midtrans transaction_id
  payment_date    DateTime?
  expired_at      DateTime?
  snap_token      String?      @db.VarChar(255) // Midtrans Snap token
  snap_url        String?      @db.VarChar(500) // Midtrans Snap URL
  metadata        String?      @db.Text // JSON for additional data
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  
  // Relations
  subscription    Subscription @relation(fields: [subscription_id], references: [subscription_id], onDelete: Cascade)

  @@index([subscription_id])
  @@index([order_id])
  @@index([status])
  @@map("payments")
}

model Attendance {
  attendance_id    Int                         @id @default(autoincrement())
  employee_id      Int
  tanggal          DateTime
  jam_masuk        String?                     @db.VarChar(10)
  jam_pulang       String?                     @db.VarChar(10)
  status           String                      @default("hadir") @db.VarChar(20)
  keterangan       String?                     @db.Text
  tipe_kerja       String                      @default("WFO") @db.VarChar(20)
  approval_status  attendance_approval_status? @default(approved)
  approved_by      Int?
  approval_notes   String?                     @db.Text
  approval_date    DateTime?                   @db.DateTime(0)
  lokasi_masuk     String?                     @db.VarChar(100)
  lokasi_pulang    String?                     @db.VarChar(100)
  akurasi_masuk    Int?
  akurasi_pulang   Int?
  recorded_by_role String?                     @db.VarChar(20)
  status_approval  String                      @default("approved") @db.VarChar(20)
  created_at       DateTime                    @default(now())
  employee         Employee                    @relation(fields: [employee_id], references: [employee_id], onDelete: Cascade)
  approver         User?                       @relation("AttendanceApprovals", fields: [approved_by], references: [user_id], onDelete: SetNull)
  overtime         Overtime?

  @@index([employee_id])
  @@index([tanggal])
  @@index([approved_by], map: "approved_by")
  @@index([approval_status], map: "idx_attendance_approval")
  @@index([employee_id, tanggal], map: "idx_attendance_employee_date")
  @@index([tipe_kerja], map: "idx_attendance_tipe_kerja")
  @@map("attendance")
}

model Overtime {
  overtime_id      Int      @id @default(autoincrement())
  employee_id      Int
  attendance_id    Int?     @unique
  tanggal          DateTime
  jam_checkout     String   @db.VarChar(10)  // Jam checkout actual
  jam_scheduled    String   @db.VarChar(10)  // Jam pulang seharusnya
  overtime_hours   Decimal  @db.Decimal(5, 2) // Durasi lembur (jam)
  bonus_per_hour   Decimal  @db.Decimal(15, 2) @default(50000.00) // Bonus per jam
  total_bonus      Decimal  @db.Decimal(15, 2) // Total bonus
  status           overtime_status @default(pending)
  approved_by      Int?
  approval_notes   String?  @db.Text
  approval_date    DateTime?
  reason           String?  @db.Text  // Alasan lembur
  created_at       DateTime @default(now())
  
  // Relations
  employee         Employee @relation(fields: [employee_id], references: [employee_id], onDelete: Cascade)
  attendance       Attendance? @relation(fields: [attendance_id], references: [attendance_id], onDelete: SetNull)
  approver         User?    @relation("OvertimeApprovals", fields: [approved_by], references: [user_id], onDelete: SetNull)
  
  @@index([employee_id])
  @@index([tanggal])
  @@index([status])
  @@index([approved_by])
  @@map("overtime")
}


model LeaveRequest {
  leave_id          Int      @id @default(autoincrement())
  employee_id       Int
  tanggal_pengajuan DateTime
  tanggal_mulai     DateTime
  tanggal_selesai   DateTime
  jenis_pengajuan   String   @default("Cuti") @db.VarChar(20)
  alasan            String   @db.Text
  status            String   @default("pending") @db.VarChar(20)
  created_at        DateTime @default(now())
  total_days        Int      @default(0)
  attachment_path     String?  @db.VarChar(255)
  attachment_filename String?  @db.VarChar(255)
  employee          Employee @relation(fields: [employee_id], references: [employee_id], onDelete: Cascade)

  @@index([employee_id])
  @@index([status])
  @@map("leave_requests")
}

model Payroll {
  payroll_id      Int      @id @default(autoincrement())
  employee_id     Int
  periode         String   @db.VarChar(10)
  gaji_pokok      Decimal  @db.Decimal(15, 2)
  tunjangan       Decimal  @default(0.00) @db.Decimal(15, 2)
  potongan        Decimal  @default(0.00) @db.Decimal(15, 2)
  alasan_potongan String?  @db.Text
  total_gaji      Decimal  @db.Decimal(15, 2)
  employee_role   String?  @db.VarChar(50)
  created_at      DateTime @default(now())
  employee        Employee @relation(fields: [employee_id], references: [employee_id], onDelete: Cascade)

  @@unique([employee_id, periode])
  @@index([employee_id])
  @@map("payroll")
}

model Performance {
  performance_id Int      @id @default(autoincrement())
  employee_id    Int
  periode        String   @db.VarChar(20)
  nilai_kinerja  Int      @default(0)
  catatan        String?  @db.Text
  created_at     DateTime @default(now())
  employee       Employee @relation(fields: [employee_id], references: [employee_id], onDelete: Cascade)

  @@index([employee_id])
  @@map("performance")
}


model WorkSchedule {
  schedule_id      Int                @id @default(autoincrement())
  schedule_name    String             @db.VarChar(100)
  shift_type       String             @db.VarChar(50) // "Regular", "Shift", "Flexible"
  start_time       String             @db.VarChar(5)  // "08:00"
  end_time         String             @db.VarChar(5)  // "17:00"
  break_duration   Int                @default(60)    // menit
  work_days        String             @db.VarChar(50) // "Mon-Fri" atau "Mon,Tue,Wed"
  is_active        Boolean            @default(true)
  created_at       DateTime           @default(now())
  updated_at       DateTime           @updatedAt
  
  // Relations
  employee_schedules EmployeeSchedule[]
  shift_rotations    ShiftRotation[]
  
  @@map("work_schedules")
}

model EmployeeSchedule {
  id               Int              @id @default(autoincrement())
  employee_id      Int
  schedule_id      Int
  effective_date   DateTime
  end_date         DateTime?
  is_active        Boolean          @default(true)
  notes            String?          @db.Text
  created_at       DateTime         @default(now())
  
  // Relations
  employee         Employee         @relation(fields: [employee_id], references: [employee_id], onDelete: Cascade)
  schedule         WorkSchedule     @relation(fields: [schedule_id], references: [schedule_id], onDelete: Cascade)
  
  @@index([employee_id])
  @@index([schedule_id])
  @@index([effective_date])
  @@map("employee_schedules")
}

model ShiftRotation {
  rotation_id      Int              @id @default(autoincrement())
  schedule_id      Int
  rotation_name    String           @db.VarChar(100)
  rotation_pattern String           @db.Text        // JSON: [{day: "Monday", schedule_id: 1}, ...]
  start_date       DateTime
  end_date         DateTime?
  is_active        Boolean          @default(true)
  created_at       DateTime         @default(now())
  
  // Relations
  schedule         WorkSchedule     @relation(fields: [schedule_id], references: [schedule_id], onDelete: Cascade)
  
  @@index([schedule_id])
  @@map("shift_rotations")
}


model password_reset_tokens {
  id         Int      @id @default(autoincrement())
  user_id    Int
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@index([expires_at])
  @@map("password_reset_tokens")
}

enum attendance_approval_status {
  pending
  approved
  rejected
}

enum overtime_status {
  pending
  approved
  rejected
}